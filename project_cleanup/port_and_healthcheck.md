# Решение проблем с подключением и проверками состояния в Streamlit Cloud

## Проблема

При деплое приложения в Streamlit Cloud часто возникает ошибка:

```
The service has encountered an error while checking the health of the Streamlit app:
Get "http://localhost:8501/healthz": dial tcp 127.0.0.1:8501: connect: connection refused
```

Эта ошибка означает, что приложение не запускается на ожидаемом порту 8501, или указанный порт недоступен для проверки состояния.

## Комплексное решение

В нашем проекте реализовано многоуровневое решение для обеспечения стабильной работы в Streamlit Cloud:

### 1. Правильная конфигурация портов

Файл `.streamlit/config_cloud.toml` содержит правильную конфигурацию:

```toml
[server]
headless = true
port = 8501
address = "0.0.0.0"  # Важно для прослушивания на всех интерфейсах
enableCORS = false
enableXsrfProtection = false
```

### 2. Улучшенный скрипт запуска `entry.sh`

Скрипт `entry.sh` теперь содержит:
- Принудительное создание правильной конфигурации в рантайме
- Явное указание параметров сервера при запуске
- Расширенный вывод диагностической информации

```bash
# Перестраховка: создаем правильный конфиг
mkdir -p .streamlit
cat > .streamlit/config.toml << EOL
[server]
headless = true
port = 8501
address = "0.0.0.0"
enableCORS = false
enableXsrfProtection = false
EOL

# Запуск с явным указанием параметров
streamlit run app_cloud.py --server.port $PORT --server.address 0.0.0.0
```

### 3. Расширенный healthcheck в `healthcheck.py`

Отдельный скрипт для проверки доступности:
- Проверяет порт на различных интерфейсах (localhost, 127.0.0.1, 0.0.0.0)
- Выполняет несколько попыток с задержкой
- Выводит подробную диагностическую информацию

### 4. Настройка в Procfile

```
web: bash entry.sh
healthcheck: python healthcheck.py
```

### 5. Диагностика в приложении

В `app_cloud.py` добавлен:
- Проверка доступности порта при запуске
- Вывод системной информации в логи
- Встроенный раздел отладочной информации в интерфейсе

## Как использовать

1. **Подготовка к деплою**
   ```bash
   ./prepare_for_deploy.sh
   ```

2. **Деплой в Streamlit Cloud**
   - Укажите `app_cloud.py` как точку входа
   - Выберите Python 3.11 (файл `runtime.txt`)
   - Проверьте логи для диагностики

3. **Проверка состояния после деплоя**
   - Откройте консоль логов в Streamlit Cloud
   - Обратите внимание на вывод диагностики из entry.sh
   - Если приложение не запускается, запустите healthcheck вручную

## Решение известных проблем

1. **Port already in use**
   - Проверьте, нет ли уже запущенных экземпляров приложения
   - Убедитесь, что приложение не пытается запуститься на другом порту

2. **Configuration not applied**
   - Проверьте, что скрипт entry.sh имеет права на выполнение
   - Проверьте, что config.toml создается с правильным содержимым

3. **Healthcheck fails but app is running**
   - Проверьте, что приложение слушает на всех интерфейсах (0.0.0.0)
   - Проверьте логи на наличие ошибок загрузки модулей

## Возврат к локальной разработке

После деплоя не забудьте вернуться к локальной конфигурации:

```bash
./restore_local_config.sh
```